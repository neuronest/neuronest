name: object_detection

on:
  push:
    branches:
      - main
      - develop
    paths:
      - .github/**
      - shared/**
      - object-detection/**
  pull_request:
    branches:
      - main
      - develop
    paths:
      - .github/**
      - shared/**
      - object-detection/**
  workflow_dispatch:

env:
  IMAGE_REPOSITORY: object-detection
  DOCKERFILE_PATH: dockerfiles/object_detection.dockerfile
  SERVICE_ACCOUNT_NAME: object-detection
  CI_SERVICE_ACCOUNT_NAME: object-detection-ci

jobs:
  build:
    name: build
    runs-on: self-hosted
    container: docker
    env:
      TARGET: training
    outputs:
      IMAGE_NAME: ${{ steps.output_step.outputs.IMAGE_NAME }}
    steps:
      - uses: actions/checkout@v3
      - name: Set environment variables
        uses: ./.github/actions/set_variables
      - run: mkdir -p $SERVICE_ACCOUNT_DIRECTORY && echo ${{ secrets.OBJECT_DETECTION_CI_SERVICE_ACCOUNT }} | base64 -d > $GOOGLE_APPLICATION_CREDENTIALS
      - run: gcloud auth activate-service-account CI_SERVICE_ACCOUNT_NAME@$PROJECT_ID.iam.gserviceaccount.com --key-file=$GOOGLE_APPLICATION_CREDENTIALS --project=$PROJECT_ID
      - run: gcloud auth configure-docker
      - run: docker build --build-arg STAGE=$STAGE -t $ARTIFACT_REGISTRY_PATH/$IMAGE_REPOSITORY:$GITHUB_RUN_ID -t $ARTIFACT_REGISTRY_PATH/$IMAGE_REPOSITORY:latest -f $DOCKERFILE_PATH --target $TARGET .
      - run: docker push $ARTIFACT_REGISTRY_PATH/$IMAGE_REPOSITORY --all-tags
      - id: output_step
        run: echo "IMAGE_NAME=$ARTIFACT_REGISTRY_PATH/$IMAGE_REPOSITORY:$GITHUB_RUN_ID" >> $GITHUB_OUTPUT

  tests:
    name: tests
    needs:
      - build
    runs-on: self-hosted
    container: ${{needs.build.outputs.IMAGE_NAME}}
    steps:
      - uses: actions/checkout@v3
      - name: Run pre-commit
        uses: ./.github/actions/run_pre_commit
        with:
          repository_path: $IMAGE_REPOSITORY

  train:
    name: train
    needs:
      - build
    runs-on: self-hosted
    defaults:
      run:
        working-directory: /app
    container: ${{needs.build.outputs.IMAGE_NAME}}
    steps:
      - uses: actions/checkout@v3
      - name: Set environment variables
        uses: ./.github/actions/set_variables
      - run: echo "IMAGE_NAME"="${{needs.build.outputs.IMAGE_NAME}}" >> $GITHUB_ENV
      - run: mkdir -p $SERVICE_ACCOUNT_DIRECTORY && echo ${{ secrets.OBJECT_DETECTION_SERVICE_ACCOUNT }} | base64 -d > $GOOGLE_APPLICATION_CREDENTIALS
      - run: gcloud auth activate-service-account $SERVICE_ACCOUNT_NAME@$PROJECT_ID.iam.gserviceaccount.com --key-file=$GOOGLE_APPLICATION_CREDENTIALS --project=$PROJECT_ID
      - run: python -m object_detection.cli --run-id $(uuidgen) --mode training
